' Gambas class file

'
' Traducción de programas.
' Interfaz de translate-shell para traducir programas completos de gambas y otras utilidades.
'
' Copyright (C) Martín Belmonte
'
' This program is free software; you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation; either version 2 of the License, or
' (at your option) any later version.
'
' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License
' along with this program; if not, write to the Free Software
' Foundation, Inc., 51 Franklin St, Fifth Floor,
' Boston, MA  02110-1301  USA
'

Public strLangInput As String
Public stxLangOutput As New String[]
Public strLangOutput As String
Public stxLog As New String[]
Public stxMessage As New String[]

Public stxLin As New String[]
Public stxLout As New String[]

Public intMessage As Integer

' Listas de idiomas
Public bolLangloaded As Boolean
Public stxSysLangName As New String[]
Public stxSysLangDesc As New String[]
Public stxSysLangFamy As New String[]
Public stxSysLangAlph As New String[]

Public intWCtrl As Integer

Public Sub Form_Open()

  CheckLang()
  If LoadLang() = True Then
    CheckLang()
    Phrases()
  Endif

End

Public Sub tobOpenPot_Click()

  TranlatePot()

End

Public Sub tobAbout_Click()

  FAbout.Show()

End

Public Sub tobPreferences_Click()

  FPref.Show()

End

Public Sub Phrases() '' Creates a panel with a label and a textbox

  Dim pnl As Panel
  Dim lbl As Label
  Dim txo As TextBox
  Dim intPhra As Integer
  Dim strLang As String
  Dim strLangDesc As String
  Dim stxControls As New String[]
  Dim strTag As String

  stxControls.Clear
  stxControls.Add(strLangInput)
  stxControls.Insert(stxLangOutput)

  ' Agragado de botones
  pnl = New Panel(TabPanel1[1])
  With pnl
    pnl.Name = "pnl" & strLang
    pnl.Height = 28 * 2
    pnl.Width = intWCtrl
    pnl.Arrangement = 2 ' Vertical
    pnl.Expand = False
  End With

  lbl = New Label(pnl)
  With lbl
    lbl.Text = strLangDesc
    lbl.Name = "lbl" & strLang
    lbl.Height = 28
    lbl.Width = intWCtrl
    lbl.Expand = True
  End With

  TabPanel1[1].Children.Clear
  For intPhra = 0 To stxControls.Max

    strLang = String.LCase(stxControls[intPhra])
    If stxSysLangName.Find(strLang) <> -1 Then
      strLangDesc = stxSysLangDesc[stxSysLangName.Find(strLang)]
    Else
      strLangDesc = "Error"
    Endif

    If intPhra = 0 Then
      strTag = strLang & ":Input"
    Else
      strTag = strLang & ":Output"
    Endif

    pnl = New Panel(TabPanel1[1])
    With pnl
      pnl.Name = "pnl" & strLang
      pnl.Height = 28 * 2
      pnl.Width = intWCtrl
      pnl.Arrangement = 2 ' Vertical
      pnl.Expand = False
    End With

    lbl = New Label(pnl)
    With lbl
      lbl.Text = strLangDesc
      lbl.Name = "lbl" & strLang
      lbl.Height = 28
      lbl.Width = intWCtrl
      lbl.Expand = True
    End With

    txo = New TextBox(pnl) As "GPhrases"
    With txo
      txo.Name = "txo" & strLang
      txo.Height = 28
      txo.Width = intWCtrl
      txo.Expand = True
      txo.Tag = strTag
    End With

  Next

End

Public Sub GPhrases_Change()

  Dim txo As TextBox
  Dim strLangInput As String
  Dim strLangType As String
  Dim intWidth As Integer

  txo = Last

  If InStr(txo.Tag, ":") > 0 Then
    strLangInput = Split(txo.Tag, ":")[0]
    strLangType = Split(txo.Tag, ":")[1]

    intWidth = Len(txo.Text) * 7

    Select intWidth > intWCtrl
      Case False
        txo.Parent.Width = intWCtrl + 7
      Case Else
        txo.Parent.Width = intWidth + 7
    End Select

    Select strLangType
      Case "Input"
        Print strLangInput & ": " & txo.Text

      Case "Output"
        Print strLangInput & ": " & txo.Text
    End Select
  Endif

End

Public Sub TranlatePot()

  Dim strPotPath As String
  Dim intLng As Integer
  Dim strStateTrans As String

  stxMessage.Clear
  tmrChecker.Start

  CheckLang()

  strPotPath = MUtility.FileChooser(User.Home, "pot")

  If Exist(strPotPath) = True Then
    If Stat(strPotPath).Type = gb.File Then
      If String.LCase(File.Ext(strPotPath)) = "pot" Then

        If stxLangOutput.Count > 0 Then
          For intLng = 0 To stxLangOutput.Max
            strLangOutput = stxLangOutput[intLng]

            If strLangOutput <> strLangInput Then

              If MTranslate.Pomaker(strPotPath, strLangInput, strLangOutput) > 0 Then

                strStateTrans = ("Para") & " " & strLangInput & ":" & strLangOutput & " " & ("la aplicacion fue traducida exitosamente")
                Print strStateTrans
              Endif
            Else
              Message.Info(("No tiene sentido traducir de") & " " & stxSysLangDesc[stxSysLangName.Find(strLangInput)] & " " &
                "hacia" & " " & stxSysLangDesc[stxSysLangName.Find(strLangOutput)])
            Endif

          Next
          tmrChecker.Stop
          File.Save("/tmp/tradukisto.log", stxMessage.Join("\n"))
          Wait 0.1

          FillList()

          Desktop.Open("/tmp/tradukisto.log")
        Else
          Message.Info(("Tienes que seleccionar al menos un idioma destino.") & gb.NewLine &
            ("Para ello ve a las preferencias del programa"))
        Endif
      Endif
    Endif
  Endif

End

Public Sub CheckLang()

  Dim strPlan As String
  Dim intLx As Integer
  Dim intCheck As Integer

  intWCtrl = Settings["Controls/Width", 28 * 6]
  strLangInput = Settings["Language", "es"]
  stxLangOutput.Clear

  For intLx = 0 To stxSysLangName.Max

    If Settings["Output/" & String.UCase(stxSysLangName[intLx])] = -1 Then
      stxLangOutput.Add(stxSysLangName[intLx])
    Endif
  Next

  intCheck = stxLangOutput.Find(strLangInput)
  If intCheck > -1 Then
    stxLangOutput.Delete(intCheck, 1)
  Endif

  If stxLangOutput.Count > 0 Then
    strPlan = " " & (("Vas a traducir desde") & " " &
      String.UCase(strLangInput) & " " & ("hacia") & " " &
      String.UCase(stxLangOutput.Join(":")))
  Else
    strPlan = " " & ("Vas a traducir desde") & " " &
      String.UCase(strLangInput) & " " & ("pero no has seleccionado idiomas de destino, para ello ve a preferencias.")
  Endif

  lblInfo.Text = strPlan

End

Public Sub tmrChecker_Timer()

  FillList()

End

Public Sub FillList()

  Dim strInfoMsg As String

  If stxLin.Count = stxLout.Count Then
    If intMessage <> stxLin.Count Then
      intMessage = stxLin.Count
      If stxLout.Count > 0 Then
        lsoInfo.Add(stxLin[0], 0)
        lsoInfo.Add(stxLout[0], 0)
      Endif
    Endif
  Endif

  If stxLangOutput.Count > 0 Then
    If strLangOutput <> "" Then
      strInfoMsg = ("Traduciendo desde") & " " & stxSysLangDesc[stxSysLangName.Find(strLangInput)] & " " &
        "hacia" & " " & stxSysLangDesc[stxSysLangName.Find(strLangOutput)]
      lblTrad.Text = strInfoMsg
    Endif
  Endif

End

Public Sub mnuFileOpen_Click()

  TranlatePot()

End

Public Sub mnuPreferences_Click()

  FPref.Show()

End

Public Sub mnuAbout_Click()

  FAbout.Show()

End

Public Sub mnuHelp_Click()

  Message.Info("La ayuda todavia no esta disponible")

End

Public Function LoadLang() As Boolean '' Carga la lista de idiomas

  Dim stxLang As New String[]
  Dim intL As Integer
  Dim strDesc As String
  Dim strFamy As String
  Dim strLan As String
  Dim strAlph As String

  stxLang = Split(File.Load(User.Home &/ "." & Application.Name &/ "lang.csv"), "\n")

  For intL = 0 To stxLang.Max
    If stxLang[intL] <> "" Then

      strLan = Split(stxLang[intL], ":")[0]
      strDesc = Split(stxLang[intL], ":")[2] & "[" & Split(stxLang[intL], ":")[3] & "]"
      strFamy = Split(stxLang[intL], ":")[4]
      strAlph = Split(stxLang[intL], ":")[5]

      stxSysLangName.Add(strLan)
      stxSysLangDesc.Add(strDesc)
      stxSysLangFamy.Add(strFamy)
      stxSysLangAlph.Add(strAlph)
    Endif
  Next

  bolLangloaded = True

  Return True

End

Public Sub mnuQuit_Click()

  tmrChecker.Stop

  Me.Close

End

Public Sub TabPanel1_Arrange()

  CheckTab()

End

Public Sub CheckTab()

  Dim intTab As Integer

  Select TabPanel1.Current
    Case TabPanel1[0]
      tobTranslate.Enabled = False
      tobOpenPot.Enabled = True

    Case TabPanel1[1]
      tobTranslate.Enabled = True
      tobOpenPot.Enabled = False

  End Select

End

Public Sub TabPanel1_MouseDown()

  CheckTab()

End

Public Sub tobTranslate_Click()

  Dim intTxt As Integer
  Dim obj As Object
  Dim strText As String
  Dim strTrans As String

  ' averiguar el texto de entrada
  For Each obj In TabPanel1.Children
    If Object.Type(obj) = "Panel" Then
      If InStr(obj.name, "pnl" & strLangInput) > 0 Then
        strText = obj.Children[1].Text
      Endif
    Endif
  Next

  For intTxt = 0 To stxLangOutput.Max
    For Each obj In TabPanel1.Children
      If Object.Type(obj) = "Panel" Then
        If InStr(obj.name, "pnl" & stxLangOutput[intTxt]) > 0 Then

          strTrans = MTranslate.Translator(strText, strLangInput, stxLangOutput[intTxt])

          obj.Children[1].Text = strTrans
          obj.Children[1].Refresh

        Endif
      Endif
    Next
  Next

End
